<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Pi SDK & Phaser -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>Pi.init({ version: "2.0", sandbox: true });</script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tricky Turns</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom, #3199E4 0%, #58C0F2 100%);
      position: relative;
      color: #fff;
    }
    canvas { display: block; margin: 0 auto; visibility: hidden; z-index: 1; }

    /* ‚Äî‚Äî Pi Auth & User Display on Home Screen ‚Äî‚Äî */
    #user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    #user-info button {
      background: rgba(255,255,255,0.85);
      border: none;
      border-radius: 0.3rem;
      padding: 0.3rem 0.8rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #user-info button:hover {
      background: rgba(255,255,255,1);
    }

    /* Clouds */
    .bg-cloud, .start-cloud {
      position: absolute;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 60'><path d='M20,35 C20,25 35,20 45,25 C50,15 65,15 70,25 C85,25 90,35 80,45 C90,45 95,55 85,60 C75,65 55,60 50,50 C40,60 25,60 20,50 C10,50 5,40 20,35 Z' fill='%23FFFFFF'/></svg>");
      background-size: contain;
      background-repeat: no-repeat;
      filter: blur(6px);
      opacity: .8;
      animation: drift linear infinite;
      pointer-events: none;
    }
    .bg-cloud.one, .start-cloud.one { width: 260px; height: 90px; top:12%; left:10%; animation-duration:40s; }
    .bg-cloud.two, .start-cloud.two { width: 200px; height:70px; top:8%; right:12%; animation-duration:50s; }
    .bg-cloud.three, .start-cloud.three { width:300px; height:100px; top:48%; left:18%; animation-duration:45s; }
    .bg-cloud.four, .start-cloud.four { width:280px; height:95px; bottom:18%; right:22%; animation-duration:55s; }
    @keyframes drift { from{transform:translateX(0);} to{transform:translateX(-150vw);} }

    /* Start Screen */
    #start-screen {
      position: absolute; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 2rem; z-index: 2; cursor: default; -webkit-tap-highlight-color: transparent;
    }
    #start-screen h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 4rem; font-weight: 700; line-height: 1.2;
      text-align: center; text-transform: uppercase;
      letter-spacing: 0.05rem;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
      -webkit-text-stroke: 1px #0F3D75;
    }
    @media (max-width: 600px) {
      #start-screen h1 {
        font-size: 2.8rem; -webkit-text-stroke: 0.6px #0F3D75;
      }
    }

    .btn-primary {
      background: #3EAFF6; color: #fff;
      font-size: 1.25rem; font-weight: 600;
      padding: 0.75rem 2rem;
      border: none; border-radius: 2rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      cursor: pointer; transition: all 0.2s ease;
      text-align: center; text-transform: uppercase;
    }
    .btn-primary:hover {
      background: #318EE6;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    @media (max-width:600px) {
      .btn-primary {
        font-size: 1rem; padding: 0.5rem 1.5rem;
      }
    }

    .btn-secondary {
      background: rgba(255,255,255,0.8);
      color: #000; font-weight: 600; font-size: 0.9rem;
      padding: 0.2rem 0.6rem; border: none; border-radius: 0.3rem;
      cursor: pointer; transition: background 0.2s ease;
    }
    .btn-secondary:hover { background: rgba(255,255,255,1); }

    /* Pause Overlay */
    #pause-overlay {
      position: absolute; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,0.4); z-index: 4; pointer-events: none;
    }
    #pause-overlay .paused-text {
      font-size: 3.5rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: .1rem;
      color: #fff; text-shadow: 1px 1px 6px #000;
    }

    /* Game Over */
    #game-over-screen {
      position: absolute; inset: 0; display: none;
      flex-direction: column; align-items: center; justify-content: center;
      gap: 1.5rem; z-index: 3; cursor: default;
      -webkit-tap-highlight-color: transparent;
    }
    #game-over-screen h1 {
      font-family: 'Poppins',sans-serif; font-size: 4.5rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: .05rem;
      color: #fff; text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
      -webkit-text-stroke: 1px #0F3D75;
    }
    @media (max-width:600px) {
      #game-over-screen h1 { font-size:3rem; -webkit-text-stroke:0.6px #0F3D75; }
    }
    .results {
      font-size: 2rem; font-weight: 600;
      text-transform: uppercase; text-align: center;
      color: #fff; text-shadow: 0 0 4px #000;
    }
    @media (max-width:600px) {
      .results { font-size:1.6rem; }
    }
    #rankMessage {
      font-size: 1.6rem; font-weight: 600;
      text-align: center; color: #fff;
      text-shadow: 0 0 4px #000;
    }

    /* Leaderboard in Game Over */
    #leaderboard {
      margin-top:1rem; background:rgba(0,0,0,0.6);
      padding:1rem; border-radius:0.5rem;
      max-height:300px; overflow-y:auto;
      color:#fff; font-size:1rem; font-weight:600;
      width:80%; max-width:400px; text-align:left;
    }
    #leaderboard li {
      list-style: none; margin-bottom:0.4rem;
      background:rgba(255,255,255,0.05);
      padding:0.5rem 0.8rem 0.5rem 2rem;
      border-radius:0.4rem;
      display:flex; justify-content:space-between;
      position: relative;
    }
    #leaderboard li::before {
      content: attr(data-rank);
      position:absolute; left:-2.5rem;
      background:#3EAFF6; color:#fff; font-weight:700;
      font-size:0.85rem; padding:0.25rem 0.6rem;
      border-radius:1rem; min-width:2rem; text-align:center;
    }

    /* Full-Screen Leaderboard */
    #leaderboard-screen {
      position:absolute; inset:0; display:none;
      flex-direction:column; align-items:center;
      background:rgba(0,0,0,0.9); padding:2rem;
      overflow-y:auto; z-index:5;
    }
    #leaderboard-screen h2 {
      color:#fff; margin-bottom:1rem; font-weight:700;
    }
    #leaderboard-screen button {
      position:absolute; top:1rem; right:1rem;
      background:#3EAFF6; color:#fff;
      border:none; border-radius:0.3rem;
      padding:0.5rem 1rem; font-weight:700;
      cursor:pointer;
    }
    #leaderboard-screen ol {
      list-style-position:inside; width:100%; max-width:400px;
      color:#fff; padding:0; margin:0;
    }
    #leaderboard-screen li {
      margin-bottom:0.4rem; padding:0.5rem 1rem;
      background:rgba(255,255,255,0.05); border-radius:0.3rem;
      display:flex; justify-content:space-between;
      font-weight:600;
    }

    /* Fade screen */
    #fade-screen {
      position:absolute; inset:0;
      background:#000; opacity:0;
      pointer-events:none; z-index:10;
      transition: opacity 0.6s ease-in-out;
    }
    #fade-screen.fade-in { opacity:1; }
  </style>
</head>
<body>
  <!-- Background Clouds -->
  <div class="bg-cloud one"></div>
  <div class="bg-cloud two"></div>
  <div class="bg-cloud three"></div>
  <div class="bg-cloud four"></div>

  <!-- Start Screen -->
  <div id="start-screen">
    <div id="user-info">
      User: <strong id="username">Guest</strong>
      <button class="btn-secondary" id="loginBtn">Login</button>
    </div>
    <div class="start-cloud one"></div>
    <div class="start-cloud two"></div>
    <div class="start-cloud three"></div>
    <div class="start-cloud four"></div>
    <h1>TRICKY<br/>TURNS</h1>
    <button class="btn-primary start-button" id="startBtn">Tap to Start</button>
    <button class="btn-primary" id="viewLeaderboardBtn">View Leaderboard</button>
    <div class="orbit">
      <div class="ring"></div>
      <div class="circle top"></div>
      <div class="circle bottom"></div>
    </div>
  </div>

  <!-- Full-Screen Leaderboard -->
  <div id="leaderboard-screen">
    <button class="btn-primary" id="closeLeaderboardBtn">Close</button>
    <h2>Top 100 Leaderboard</h2>
    <ol id="leaderboardEntriesHome"></ol>
  </div>

  <!-- Pause Overlay -->
  <div id="pause-overlay"><div class="paused-text">Paused</div></div>

  <!-- Game Over Screen -->
  <div id="game-over-screen">
    <h1>GAME OVER</h1>
    <div class="result-wrapper">
      <div class="orb-bg" style="display:none;"></div>
      <div class="results">
        SCORE: <span id="finalScore">0</span><br/>
        BEST: <span id="bestScore">0</span>
      </div>
    </div>
    <div id="rankMessage"></div>
    <button class="btn-primary" id="homeBtn">HOME</button>
    <button class="btn-primary" id="playAgainBtn">PLAY AGAIN</button>
    <div id="leaderboard"></div>
  </div>

  <!-- Phaser Game Script -->
  <script>
    // ‚Äî‚Äî Pi Authentication setup ‚Äî‚Äî
    const scopes = ['username'];
    let piUsername = 'Guest';
    let highScore = 0;
    let useLocalHighScore = true;

    function onIncompletePaymentFound(payment) {
      console.log('Incomplete payment found:', payment);
    }

    async function initAuth() {
      try {
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        piUsername = auth.user.username;
        document.getElementById('username').innerText = piUsername;
        document.getElementById('loginBtn').style.display = 'none';
        useLocalHighScore = false;
        const res = await fetch(`/api/leaderboard/${piUsername}`);
        if (res.ok) {
          const entry = await res.json();
          highScore = entry.score;
        } else {
          highScore = 0;
        }
        localStorage.setItem('tricky_high_score', highScore);
      } catch (e) {
        console.log('Not signed in:', e);
      }
    }
    initAuth();
    document.getElementById('loginBtn').addEventListener('click', initAuth);

    // Fade helpers (fade the black overlay)
    function fadeIn(callback, duration = 600) {
      const fade = document.getElementById('fade-screen');
      fade.classList.add('fade-in');
      setTimeout(() => { callback?.(); }, duration);
    }
    function fadeOut(callback, duration = 600) {
      const fade = document.getElementById('fade-screen');
      fade.classList.remove('fade-in');
      setTimeout(() => { callback?.(); }, duration);
    }

    // Show home leaderboard
    async function showHomeLeaderboard() {
      const list = document.getElementById('leaderboardEntriesHome');
      list.innerHTML = '';
      const data = await fetch('/api/leaderboard?top=100').then(r => r.json());
      data.forEach((e, i) => {
        const li = document.createElement('li');
        li.setAttribute('data-rank', `#${i+1}`);
        li.innerHTML = `<strong>${e.username}</strong><strong>${e.score}</strong>`;
        list.appendChild(li);
      });
      document.getElementById('leaderboard-screen').style.display = 'flex';
    }
    document.getElementById('viewLeaderboardBtn').addEventListener('click', showHomeLeaderboard);
    document.getElementById('closeLeaderboardBtn').addEventListener('click', () => {
      document.getElementById('leaderboard-screen').style.display = 'none';
    });

    // Game variables
    const LANES = []; let gameStarted=false, gameOver=false, gamePaused=false;
    let direction=1, angle=0, radius=100, speed=3, maxSpeed=6;
    let circle1, circle2, obstacles, points, score=0;
    let scoreText, pauseIcon, muteIcon, pauseOverlay, countdownText;
    let sfx = {}, isMuted=false;

    // Phaser config
    const config = {
      type: Phaser.AUTO,
      transparent: true,
      scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      physics: { default: 'arcade', arcade: { debug: false } },
      scene: { key: 'default', preload, create, update }
    };
    window.game = new Phaser.Game(config);

    // Preload assets
    function preload() {
      this.load.audio('explode','assets/explode.wav');
      this.load.audio('move','assets/move.wav');
      this.load.audio('point','assets/point.wav');
      this.load.audio('newBest','assets/new_best.wav');
      this.load.audio('uiClick','assets/ui_click_subtle.wav');
      this.load.audio('pauseWhoosh','assets/pause_whoosh_subtle.wav');
      this.load.image('iconPause','assets/icon-pause.svg');
      this.load.image('iconPlay','assets/icon-play.svg');
      this.load.image('iconMute','assets/icon-mute.svg');
      this.load.image('iconUnmute','assets/icon-unmute.svg');
    }

    // Create scene
    function create() {
      // Clear old objects
      if (obstacles) obstacles.clear(true,true);
      if (points) points.clear(true,true);

      // Setup lanes
      const cam=this.cameras.main; const cx=cam.centerX, cy=cam.centerY;
      LANES[0]=cy-radius; LANES[1]=cy; LANES[2]=cy+radius;

      // Generate textures...
      this.make.graphics({add:false})
        .fillStyle(0xffffff,0.04).fillCircle(50,50,30)
        .fillStyle(0xffffff,1).fillCircle(50,50,20)
        .generateTexture('orb',100,100).destroy();
      this.make.graphics({add:false})
        .fillStyle(0x0D1B2A,1).fillRoundedRect(0,0,50,50,8)
        .generateTexture('obstacle',50,50).destroy();
      this.make.graphics({add:false})
        .fillStyle(0xffffff,0.25).fillCircle(40,40,40)
        .generateTexture('pointGlow',80,80).destroy();
      this.make.graphics({add:false})
        .fillStyle(0xffffff,1).beginPath()
        .moveTo(25,0).lineTo(50,25).lineTo(25,50).lineTo(0,25)
        .closePath().fillPath()
        .generateTexture('point',50,50).destroy();

      // Orbs & physics
      circle1=this.add.image(0,0,'orb'); this.physics.add.existing(circle1);
      circle1.body.setCircle(22.5,27.5,27.5);
      circle2=this.add.image(0,0,'orb'); this.physics.add.existing(circle2);
      circle2.body.setCircle(22.5,27.5,27.5);

      // Trail
      const trail=this.add.particles('orb');
      [circle1,circle2].forEach(c=>trail.createEmitter({
        follow:c, lifespan:300, speed:0,
        scale:{start:0.3,end:0}, alpha:{start:0.4,end:0},
        frequency:50, blendMode:'ADD'
      }));

      // Groups
      obstacles=this.physics.add.group();
      points=this.physics.add.group();

      // HUD
      scoreText=this.add.text(16,16,'Score: 0',{
        fontFamily:'Poppins', fontSize:'36px',
        color:'#fff', stroke:'#000', strokeThickness:4
      }).setDepth(2).setVisible(false);

      if (useLocalHighScore) {
        highScore = Number(localStorage.getItem('tricky_high_score'))||0;
      }

      // Icons
      pauseIcon=this.add.image(cam.width-40,40,'iconPause')
                    .setInteractive().setDepth(3).setVisible(false);
      muteIcon=this.add.image(cam.width-100,40,'iconUnmute')
                    .setInteractive().setDepth(3).setVisible(false);
      pauseOverlay=document.getElementById('pause-overlay');

      countdownText=this.add.text(cx,cy,'',{
        fontFamily:'Poppins', fontSize:'96px',
        color:'#fff', stroke:'#000', strokeThickness:6
      }).setOrigin(0.5).setDepth(5).setVisible(false);

      // Sounds
      ['explode','move','point','newBest','uiClick','pauseWhoosh']
        .forEach(key => sfx[key] = this.sound.add(key));

      // Mute toggle fix
      muteIcon.on('pointerdown', () => {
        isMuted = !isMuted;
        this.sound.setMute(isMuted);
        muteIcon.setTexture(isMuted?'iconMute':'iconUnmute');
        if (!isMuted) sfx.uiClick.play();
      });

      // Pause/play
      pauseIcon.on('pointerdown', (_,x,y,e) => {
        e.stopPropagation();
        if (!gameStarted||gameOver) return;
        if (!gamePaused) {
          gamePaused = true;
          pauseIcon.setTexture('iconPlay');
          sfx.pauseWhoosh.play();
          this.physics.pause();
          pauseOverlay.style.display='flex';
        } else {
          sfx.pauseWhoosh.play();
          let count=3;
          countdownText.setText(count).setVisible(true);
          this.time.addEvent({
            delay:1000, repeat:2, callback: () => {
              count--;
              if (count>0) countdownText.setText(count);
              else {
                countdownText.setVisible(false);
                gamePaused = false;
                pauseIcon.setTexture('iconPause');
                this.physics.resume();
                pauseOverlay.style.display='none';
              }
            }
          });
        }
      });

      // Rotate on tap
      this.input.on('pointerdown', () => {
        if (gameStarted&&!gameOver&&!gamePaused) {
          direction *= -1;
          sfx.move.play();
          this.tweens.add({
            targets:[circle1,circle2],
            scaleX:1.15, scaleY:1.15,
            yoyo:true, duration:100, ease:'Quad.easeInOut'
          });
        }
      });

      // Collisions
      this.physics.add.overlap(circle1, obstacles, triggerGameOver, null, this);
      this.physics.add.overlap(circle2, obstacles, triggerGameOver, null, this);
      this.physics.add.overlap(circle1, points, collectPoint, null, this);
      this.physics.add.overlap(circle2, points, collectPoint, null, this);

      // Speed ramp
      this.time.addEvent({ delay:1000, loop:true, callback:() => {
        if (gameStarted&&!gameOver&&!gamePaused) {
          speed += speed>1.5 ? 0.006 : (speed>=1.2 ? 0.0015 : 0);
        }
      }});

      // Spawn scheduler
      const scene = this;
      function getSpawnInterval(){
        const t = Phaser.Math.Clamp((speed-3)/(maxSpeed-3),0,1);
        return Phaser.Math.Linear(1500,500,t);
      }
      function scheduleSpawn(){
        scene.time.delayedCall(getSpawnInterval(), ()=>{
          if (gameStarted&&!gameOver&&!gamePaused) spawnObjects.call(scene);
          scheduleSpawn();
        }, [], scene);
      }

      // START button
      document.getElementById('startBtn').addEventListener('click', ()=>{
        sfx.uiClick.play();
        fadeIn(() => {
          document.getElementById('user-info').style.display='none';
          document.getElementById('viewLeaderboardBtn').style.display='none';
          document.getElementById('start-screen').style.display='none';
          gameStarted = true;
          document.querySelector('canvas').style.visibility='visible';
          scoreText.setVisible(true);
          pauseIcon.setVisible(true);
          muteIcon.setVisible(true);
          scheduleSpawn();
          fadeOut();
        });
      });

      // HOME button (reload)
      document.getElementById('homeBtn').addEventListener('click', () => {
        fadeIn(() => window.location.href = window.location.href);
      });

      // PLAY AGAIN button (restart scene)
      document.getElementById('playAgainBtn').addEventListener('click', () => {
        sfx.uiClick.play();
        document.getElementById('game-over-screen').style.display='none';
        window.game.scene.scenes[0].scene.restart();
      });
    }

    // Update loop
    function update(){
      if (!gameStarted||gameOver||gamePaused) return;
      angle += 0.05 * direction;
      const o1 = Phaser.Math.Vector2.RIGHT.clone().rotate(angle).scale(radius);
      const o2 = Phaser.Math.Vector2.RIGHT.clone().rotate(angle+Math.PI).scale(radius);
      circle1.setPosition(this.cameras.main.centerX+o1.x, this.cameras.main.centerY+o1.y);
      circle2.setPosition(this.cameras.main.centerX+o2.x, this.cameras.main.centerY+o2.y);
      obstacles.children.iterate(o => o.x -= speed);
      points.children.iterate(p => p.x -= speed);
    }

    // Spawn obstacles/points
    function spawnObjects(){
      const y = Phaser.Math.RND.pick(LANES);
      const fromLeft = Phaser.Math.Between(0,1)===0;
      const x = fromLeft ? -50 : this.cameras.main.width+50;
      const vx = (fromLeft?speed:-speed) * 60;
      if (Phaser.Math.Between(1,100) <= 35) {
        this.add.image(x,y,'pointGlow').setDepth(1).setBlendMode('ADD');
        const p = this.physics.add.image(x,y,'point').setDepth(2);
        p.body.setSize(50,50).setOffset(-25,-25).setVelocityX(vx);
        points.add(p);
      } else {
        const o = this.physics.add.image(x,y,'obstacle').setDepth(1);
        o.body.setSize(50,50).setOffset(-25,-25).setImmovable(true).setVelocityX(vx);
        obstacles.add(o);
      }
    }

    // Game over
    function triggerGameOver(){
      if (gameOver) return;
      gameOver = true;
      // Explosion particles
      [circle1,circle2].forEach(c=>{
        const px=c.x, py=c.y; c.destroy();
        this.add.particles('orb').createEmitter({
          x:px,y:py, speed:{min:150,max:350}, angle:{min:0,max:360},
          scale:{start:0.8,end:0}, lifespan:500, blendMode:'ADD', quantity:8
        });
      });
      sfx.explode.play();
      this.time.delayedCall(700, ()=>{
        this.physics.pause();
        document.querySelector('canvas').style.visibility='hidden';
        document.getElementById('finalScore').innerText = score;
        if (score > highScore) {
          highScore = score;
          sfx.newBest.play();
        }
        document.getElementById('bestScore').innerText = highScore;
        if (useLocalHighScore) localStorage.setItem('tricky_high_score', highScore);
        if (!useLocalHighScore) {
          fetch('/api/leaderboard', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ username: piUsername, score: highScore })
          }).catch(console.error);
        }

        // GET top-100 and show rank
        fetch('/api/leaderboard?top=100').then(r=>r.json()).then(data=>{
          const list = document.getElementById('leaderboard');
          if (list) {
            list.innerHTML = '<h3>Top 100</h3><ol>';
            data.forEach((e,i)=>{
              list.innerHTML += `<li data-rank="#${i+1}"><strong>${e.username}</strong><strong>${e.score}</strong></li>`;
            });
            list.innerHTML += '</ol>';
            list.style.display='block';
          }
          const idx = data.findIndex(e=>e.username===piUsername);
          const msg = document.getElementById('rankMessage');
          msg.innerText = idx>=0
            ? `üèÖ Your Global Rank: #${idx+1}`
            : `üí° You're currently unranked ‚Äî keep playing!`;
          document.getElementById('game-over-screen').style.display='flex';
        }).catch(console.error);
      });
    }

    // Collect point
    function collectPoint(_,pt){
      pt.destroy();
      score++;
      sfx.point.play();
      scoreText.setText('Score: '+score);
      this.tweens.add({
        targets: scoreText,
        scaleX:1.1, scaleY:1.1,
        yoyo:true, duration:80, ease:'Sine.easeOut'
      });
    }
  </script>

  <!-- Fade overlay -->
  <div id="fade-screen"></div>
</body>
</html>
