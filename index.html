<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Pi SDK (must load before any Pi.* calls) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>Pi.init({ version: "2.0", sandbox: true });</script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tricky Turns</title>

  <!-- Phaser 3 -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet"/>

  <style>
    /* â€”â€” Reset & Base â€”â€” */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom, #3199E4 0%, #58C0F2 100%);
      position: relative;
    }
    canvas { display: block; margin: 0 auto; visibility: hidden; z-index: 1; }

    /* â€”â€” Pi Auth & User Display on Home Screen â€”â€” */
    #user-info {
      display: flex; align-items: center; gap: 0.5rem;
      color: #fff; font-size: 1rem; text-shadow: 0 0 4px #000;
    }
    #user-info button {
      background: rgba(255,255,255,0.8);
      border: none; border-radius: 0.3rem;
      padding: 0.2rem 0.6rem; font-weight: 700; cursor: pointer;
    }

    /* â€”â€” Clouds â€”â€” */
    .bg-cloud, .start-cloud {
      position: absolute;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 60'><path d='M20,35 C20,25 35,20 45,25 C50,15 65,15 70,25 C85,25 90,35 80,45 C90,45 95,55 85,60 C75,65 55,60 50,50 C40,60 25,60 20,50 C10,50 5,40 20,35 Z' fill='%23FFFFFF'/></svg>");
      background-size: contain;
      background-repeat: no-repeat;
      filter: blur(6px);
      opacity: 0.8;
      animation: drift linear infinite;
      pointer-events: none;
    }
    .bg-cloud.one,   .start-cloud.one   { width: 260px; height: 90px;  top: 12%;  left: 10%;   animation-duration: 40s; }
    .bg-cloud.two,   .start-cloud.two   { width: 200px; height: 70px;  top: 8%;   right: 12%;  animation-duration: 50s; }
    .bg-cloud.three, .start-cloud.three { width: 300px; height: 100px; top: 48%;  left: 18%;   animation-duration: 45s; }
    .bg-cloud.four,  .start-cloud.four  { width: 280px; height: 95px;  bottom: 18%; right: 22%; animation-duration: 55s; }
    @keyframes drift { from { transform: translateX(0); } to { transform: translateX(-150vw); } }

    /* â€”â€” Start Screen â€”â€” */
    #start-screen {
      position: absolute; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 4rem; z-index: 2; cursor: pointer;
    }
    #start-screen h1 {
      color: #fff;
      font-size: 5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1rem;
      text-align: center;
      line-height: 1.1;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
      -webkit-text-stroke: 0.7px #0F3D75;
    }
    @media (max-width: 600px) {
      #start-screen h1 { font-size: 3rem; }
      .orbit { width: 180px; height: 180px; }
      .ring  { border-width: 6px; }
      .circle{ width: 45px; height: 45px; }
    }

    /* â€”â€” Button Styles â€”â€” */
    .btn-primary {
      background: #3EAFF6;
      color: #fff;
      font-size: clamp(1.2rem, 2vw, 2rem);
      font-weight: 700;
      padding: clamp(0.8rem, 1.5vw, 1.2rem) clamp(2.5rem, 3vw, 3rem);
      border: none;
      border-radius: 2rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .btn-primary:hover {
      background: #318EE6;
      box-shadow: 0 12px 32px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    @media (max-width: 600px) {
      .btn-primary {
        font-size: 1.1rem;
        padding: 0.6rem 1.8rem;
      }
    }

    .btn-secondary {
      background: rgba(255,255,255,0.8);
      color: #000;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      font-size: 0.9rem;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,1);
    }

    /* â€”â€” Icon Button (Mute) â€”â€” */
    .icon-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255,255,255,0.8);
      border: none;
      border-radius: 0.3rem;
      padding: 0.4rem;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .icon-btn:hover {
      background: rgba(255,255,255,1);
    }

    /* â€”â€” Pause Screen â€”â€” */
    #pause-screen {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5); visibility: hidden;
      z-index: 3;
    }
    #pause-screen h2 {
      color: #fff; font-size: 2rem; text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
    }

    /* â€”â€” Game Over Screen â€”â€” */
    #game-over-screen {
      position: absolute; inset: 0;
      display: none; flex-direction: column; align-items: center;
      justify-content: center; background: rgba(0,0,0,0.7);
      z-index: 4; color: #fff; text-align: center;
    }
    #game-over-screen h2 {
      font-size: 2.5rem; margin-bottom: 1rem;
    }
    #game-over-screen button {
      margin-top: 1rem; padding: 0.6rem 1.2rem; font-size: 1rem;
      border: none; border-radius: 0.3rem; cursor: pointer;
    }

    /* â€”â€” Leaderboard Overlay â€”â€” */
    #leaderboard-screen {
      position: absolute; inset: 0;
      display: none; flex-direction: column; align-items: center;
      justify-content: center; background: rgba(0,0,0,0.8);
      z-index: 5;
    }
    #leaderboard-screen h3 {
      color: #fff; margin-bottom: 0.5rem;
    }
    #leaderboard-screen ul {
      list-style: none; width: 80%; max-width: 400px;
      max-height: 300px; overflow-y: auto;
      padding: 1rem; background: rgba(255,255,255,0.1);
      border-radius: 0.5rem; color: #fff;
      text-align: left; line-height: 1.4; font-size: 1rem;
    }

    /* â€”â€” Fade Screen â€”â€” */
    #fade-screen {
      position: absolute; inset: 0; background: #000;
      opacity: 0; visibility: hidden; transition: opacity 0.6s ease;
      z-index: 6;
    }

    /* â€”â€” UI/UX Enhancements Override â€”â€” */
    html { font-size: clamp(14px, 2vw, 18px); }
    #user-info { opacity: 1; transition: opacity 0.5s ease; }
    .fade-out { opacity: 0; }
  </style>
</head>
<body>
  <!-- Background Clouds -->
  <div class="bg-cloud one"></div>
  <div class="bg-cloud two"></div>
  <div class="bg-cloud three"></div>
  <div class="bg-cloud four"></div>

  <!-- Start Screen -->
  <div id="start-screen">
    <!-- User info & Login -->
    <div id="user-info">
      User: <strong id="username">Guest</strong>
      <button class="btn-secondary" id="loginBtn">Login</button>
    </div>
    <!-- Mute Toggle -->
    <button class="icon-btn" id="muteBtn">ðŸ”‡</button>

    <!-- Foreground Clouds -->
    <div class="start-cloud one"></div>
    <div class="start-cloud two"></div>
    <div class="start-cloud three"></div>
    <div class="start-cloud four"></div>

    <h1>TRICKY<br/>TURNS</h1>
    <button class="btn-primary" id="startBtn">TAP TO START</button>
    <button class="btn-secondary" id="viewLeaderboardBtn">VIEW LEADERBOARD</button>

    <div class="orbit">
      <div class="ring"></div>
      <div class="circle top"></div>
      <div class="circle bottom"></div>
    </div>
  </div>

  <!-- Pause Overlay -->
  <div id="pause-screen">
    <h2>PAUSED</h2>
  </div>

  <!-- Game Over Overlay -->
  <div id="game-over-screen">
    <h2>GAME OVER</h2>
    <button class="btn-primary" id="restartBtn">RESTART</button>
  </div>

  <!-- Leaderboard Overlay -->
  <div id="leaderboard-screen">
    <h3>LEADERBOARD</h3>
    <ul id="leaderboardEntriesHome"></ul>
    <button class="btn-secondary" id="closeLeaderboardBtn">CLOSE</button>
  </div>

  <!-- Fade Screen -->
  <div id="fade-screen"></div>

  <script>
    // â€”â€” Pi Authentication setup â€”â€”  
    const scopes = ['username'];
    let piUsername = 'Guest';
    let highScore = 0;
    let useLocalHighScore = true;

    function onIncompletePaymentFound(payment) {
      console.log('Incomplete payment found:', payment);
    }

    // Handles Pi authentication flow and user high score retrieval from server
    async function initAuth() {
      try {
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        piUsername = auth.user.username;
        document.getElementById('username').innerText = piUsername;
        // Fade out and hide user-info container
        const userInfo = document.getElementById('user-info');
        userInfo.classList.add('fade-out');
        setTimeout(() => { userInfo.style.display = 'none'; }, 500);
        useLocalHighScore = false;
        // Fetch user's high score
        const res = await fetch(`/api/leaderboard/${piUsername}`);
        highScore = res.ok ? (await res.json()).score : 0;
        localStorage.setItem('tricky_high_score', highScore);
      } catch (e) {
        console.log('Not signed in:', e);
      }
    }

    // Attempt silent auth on load and on login button click
    initAuth();
    document.getElementById('loginBtn').addEventListener('click', initAuth);

    // Persistent mute toggle on start screen
    const muteBtn = document.getElementById('muteBtn');
    let startMuted = (localStorage.getItem('muted') === 'true');
    function updateStartMuteIcon() {
      muteBtn.textContent = startMuted ? 'ðŸ”‡' : 'ðŸ”Š';
    }
    updateStartMuteIcon();
    muteBtn.addEventListener('click', () => {
      startMuted = !startMuted;
      localStorage.setItem('muted', startMuted);
      updateStartMuteIcon();
    });

    // â€”â€” Fade-In / Fade-Out Helpers â€”â€”  
    function fadeIn(callback, duration = 600) {
      const fade = document.getElementById('fade-screen');
      fade.style.visibility = 'visible';
      fade.style.opacity = '1';
      setTimeout(() => {
        callback?.();
      }, duration);
    }
    function fadeOut(callback, duration = 600) {
      const fade = document.getElementById('fade-screen');
      fade.style.opacity = '0';
      setTimeout(() => {
        fade.style.visibility = 'hidden';
        callback?.();
      }, duration);
    }

    // â€”â€” Home Leaderboard â€”â€”  
    async function showHomeLeaderboard() {
      const list = document.getElementById('leaderboardEntriesHome');
      list.innerHTML = '';
      const data = await fetch('/api/leaderboard?top=100').then(r => r.json());
      data.forEach((e, i) => {
        const li = document.createElement('li');
        li.setAttribute('data-rank', `#${i + 1}`);
        li.innerHTML = `<strong>${e.username}</strong><span>${e.score}</span>`;
        list.appendChild(li);
      });
      document.getElementById('leaderboard-screen').style.display = 'flex';
    }
    document.getElementById('viewLeaderboardBtn').addEventListener('click', showHomeLeaderboard);
    document.getElementById('closeLeaderboardBtn').addEventListener('click', () => {
      document.getElementById('leaderboard-screen').style.display = 'none';
    });

    // â€”â€” Phaser Game Configuration â€”â€”  
    const config = {
      type: Phaser.AUTO,
      width: 360,
      height: 640,
      scene: {
        preload,
        create,
        update
      }
    };
    new Phaser.Game(config);

    // â€”â€” Preload Assets â€”â€”  
    function preload() {
      this.load.audio('explode', 'assets/explode.wav');
      this.load.audio('move', 'assets/move.wav');
      this.load.audio('point', 'assets/point.wav');
      this.load.audio('newBest', 'assets/new_best.wav');
      this.load.audio('uiClick', 'assets/ui_click_subtle.wav');
      this.load.audio('pauseWhoosh', 'assets/pause_whoosh_subtle.wav');
    }

    // â€”â€” Create Game Entities â€”â€”  
    let obstacles, player, cursors, scoreText, score = 0, sfx = {};
    function create() {
      // Show canvas
      this.game.canvas.style.visibility = 'visible';

      // Audio setup
      sfx = {
        explode: this.sound.add('explode'),
        move: this.sound.add('move'),
        point: this.sound.add('point'),
        newBest: this.sound.add('newBest'),
        uiClick: this.sound.add('uiClick'),
        pauseWhoosh: this.sound.add('pauseWhoosh')
      };
      this.sound.mute = startMuted;

      // Player orb
      player = this.physics.add.image(180, 320, null).setDisplaySize(50, 50).setTint(0xF2C94C);
      player.body.setCircle(25);

      // Obstacles group
      obstacles = this.physics.add.group();

      // Score text
      scoreText = this.add.text(10, 10, 'Score: 0', { fontSize: '1.5rem', fill: '#fff' }).setScrollFactor(0);

      // Input
      cursors = this.input.keyboard.createCursorKeys();
      this.input.on('pointerdown', () => {
        player.body.velocity.y = -200;
        sfx.move.play();
      });

      // Collision
      this.physics.add.overlap(player, obstacles, () => {
        sfx.explode.play();
        this.scene.pause();
        document.getElementById('game-over-screen').style.display = 'flex';
      });

      // Spawn loop
      this.time.addEvent({
        delay: 1000,
        loop: true,
        callback: spawnObstacle,
        callbackScope: this
      });
    }

    // â€”â€” Update Loop â€”â€”  
    function update() {
      // Gravity & movement
      player.body.velocity.y += 10;
      if (player.y > 700 || player.y < -50) {
        this.scene.pause();
        document.getElementById('game-over-screen').style.display = 'flex';
      }
    }

    // â€”â€” Spawn Obstacles â€”â€”  
    function spawnObstacle() {
      const x = Phaser.Math.Between(50, 310);
      const obs = obstacles.create(x, -50, null).setDisplaySize(40, 40).setTint(0xEB5757);
      obs.body.setCircle(20);
      obs.body.velocity.y = 200;
      obs.setCollideWorldBounds(false);
      // Remove when off-screen
      obs.body.checkWorldBounds = true;
      obs.body.onWorldBounds = true;
      obs.body.world.on('worldbounds', body => {
        if (body.gameObject === obs) obs.destroy();
      });
    }

    // â€”â€” Restart Logic â€”â€”  
    document.getElementById('restartBtn').addEventListener('click', () => {
      document.getElementById('game-over-screen').style.display = 'none';
      score = 0;
      scoreText.setText('Score: 0');
      obstacles.clear(true, true);
      this.scene.restart();
    });

  </script>
</body>
</html>
